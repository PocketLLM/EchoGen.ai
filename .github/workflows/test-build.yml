name: Test Build System

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android APK'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'Build iOS IPA'
        required: false
        default: false
        type: boolean

jobs:
  validate-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.2'
          channel: 'stable'

      - name: Upgrade Flutter
        run: |
          flutter upgrade --force
          flutter --version
          dart --version

      - name: Flutter Doctor
        run: flutter doctor -v

      - name: Validate pubspec.yaml
        run: |
          echo "ðŸ“‹ Validating pubspec.yaml..."
          flutter pub get --dry-run
          echo "âœ… pubspec.yaml is valid"

      - name: Check dependencies
        run: |
          echo "ðŸ“¦ Checking dependencies..."
          flutter pub get
          flutter pub deps
          echo "âœ… Dependencies resolved successfully"

      - name: Analyze code
        run: |
          echo "ðŸ” Running code analysis..."
          flutter analyze
          echo "âœ… Code analysis passed"

      - name: Check formatting
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          dart format --output=none --set-exit-if-changed .
          echo "âœ… Code formatting is correct"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          flutter test
          echo "âœ… All tests passed"

  test-android-build:
    needs: validate-setup
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_android == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.2'
          channel: 'stable'

      - name: Upgrade Flutter
        run: |
          flutter upgrade --force
          flutter --version

      - name: Build Android APK
        run: |
          echo "ðŸ”¨ Testing Android APK build..."
          flutter clean
          flutter pub get
          flutter build apk --release --verbose
          echo "âœ… Android APK build successful!"
          
          # Check file exists and size
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "ðŸ“± APK file created successfully"
            echo "ðŸ“Š APK size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
          else
            echo "âŒ APK file not found!"
            exit 1
          fi

      - name: Build Android App Bundle
        run: |
          echo "ðŸ“¦ Testing Android App Bundle build..."
          flutter build appbundle --release --verbose
          echo "âœ… Android App Bundle build successful!"
          
          # Check file exists and size
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "ðŸ“± AAB file created successfully"
            echo "ðŸ“Š AAB size: $(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)"
          else
            echo "âŒ AAB file not found!"
            exit 1
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-android-builds
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: 1

  test-ios-build:
    needs: validate-setup
    runs-on: macos-latest
    if: ${{ github.event.inputs.build_ios == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.2'
          channel: 'stable'

      - name: Upgrade Flutter
        run: |
          flutter upgrade --force
          flutter --version

      - name: Build iOS
        run: |
          echo "ðŸŽ Testing iOS build..."
          flutter clean
          flutter pub get
          flutter build ios --release --no-codesign --verbose
          echo "âœ… iOS build successful!"
          
          # Check if Runner.app exists
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            echo "ðŸ“± iOS app created successfully"
            echo "ðŸ“Š App size: $(du -sh build/ios/iphoneos/Runner.app | cut -f1)"
          else
            echo "âŒ iOS app not found!"
            ls -la build/ios/iphoneos/
            exit 1
          fi

      - name: Create test IPA
        run: |
          echo "ðŸ“¦ Creating test IPA..."
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../test-ios-build.ipa Payload/
          cd ../../..
          
          if [ -f "test-ios-build.ipa" ]; then
            echo "âœ… IPA created successfully"
            echo "ðŸ“Š IPA size: $(du -h test-ios-build.ipa | cut -f1)"
          else
            echo "âŒ IPA creation failed!"
            exit 1
          fi

      - name: Upload test iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-ios-build
          path: test-ios-build.ipa
          retention-days: 1

  summary:
    needs: [validate-setup, test-android-build, test-ios-build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸŽ¯ Build Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-setup.result }}" == "success" ]; then
            echo "âœ… **Setup Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Setup Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.build_android }}" == "true" ]; then
            if [ "${{ needs.test-android-build.result }}" == "success" ]; then
              echo "âœ… **Android Build**: Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Android Build**: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Android Build**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.build_ios }}" == "true" ]; then
            if [ "${{ needs.test-ios-build.result }}" == "success" ]; then
              echo "âœ… **iOS Build**: Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **iOS Build**: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **iOS Build**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "If all tests passed, you can safely push to main branch to trigger a release!" >> $GITHUB_STEP_SUMMARY
